let socket = null;
const channel = "mumulala_todo";

const subscribeTo = () => {
  socket.send(
    JSON.stringify({
      command: "subscribe",
      identifier: JSON.stringify({
        channel: channel,
      }),
    })
  );
};

const sendMessage = (message, action) => {
  console.log("sending message", message, action);
  socket.send(
    JSON.stringify({
      command: "message",
      identifier: JSON.stringify({
        channel: channel,
      }),
      data: JSON.stringify({
        content: message,
        action: action,
      }),
    })
  );
};

const Form = {
  form: document.getElementById("todo_form"),
  todoInput: document.getElementById("todo_input"),
  onFormSubmit: function (e) {
    console.log("on form submit", Form.todoInput);
    e.preventDefault();
    console.log("submitting form", Form.todoInput.value);
    sendMessage(Form.todoInput.value, "add_todo");
    Form.todoInput.value = "";
  },
  init: function () {
    console.log("init form", this.form)
    this.form.addEventListener("submit", this.onFormSubmit, false);
  },
};

(function init() {
  socket = new WebSocket("ws://0.0.0.0:9292/cable");

  socket.onopen = function (e) {
    console.info("[connected] : Connection established to the server");
    subscribeTo(channel);
  };

  socket.onmessage = function (e) {
    const data = JSON.parse(e.data)

    if (data.type !== "ping") {
      console.log("[message] : Message from the server", data);
    }
  };

  socket.onerror = function (e) {
    console.error("[error] : Error establishing connection", e.message);
  };
})();

(function todoInit() {
  Form.init();
})();
